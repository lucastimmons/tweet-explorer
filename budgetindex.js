var data = {};

(function() {

data = budgetspeech({
  speeches: [
"\nRONLIEPERT: Mr. Speaker, it is with a great deal of pleasure and tremendous pride that I rise in the Assembly today to deliver the 2012 Alberta budget.",
"\nRONLIEPERT: This will be the first and only budget that I will have the privilege of presenting to the House because, like you, Mr. Speaker, I have chosen not to stand as a candidate in the next provincial election.",
"\nRONLIEPERT: I would like to take this opportunity to thank my constituents of Calgary-West for their support over the past seven and a half years.",
"\nRONLIEPERT: It has been a great honour to represent these fine, hard-working Albertans in this Assembly - an honour for which I am sincerely grateful.",
"\nRONLIEPERT: I also want to extend my best wishes to all of my MLA colleagues, on both sides of the House. Whether they are choosing to seek re-election or follow another path, I wish them all the greatest of success.",
"\nRONLIEPERT: In addition to being a personal milestone for me, this is also the last budget that will be delivered in a session over which you will preside, Mr. Speaker. And let me say what a privilege it has been to serve with you. I\'m sure I speak for all my fellow members when I say that the Assembly just won\'t be the same without you.",
"\nRONLIEPERT: This is also the first budget to be delivered under the leadership of our new Premier.",
"\nRONLIEPERT: I\'m sure most Albertans share my view that much has changed in the past 100 days or so since our Premier was sworn in.",
"\nRONLIEPERT: And as Finance Minister, I can tell you, one thing that\'s definitely changing is the approach our government is taking to managing Albertans\' tax dollars.",
"\nRONLIEPERT: Mr. Speaker, one need look no further than the uncertainty that is affecting so many European countries to see that the modern global economy is not well served by old assumptions and old ways of doing things.",
"\nRONLIEPERT: Even the United States, long regarded as the world\'s greatest free market success story, is once again nearing its debt ceiling, which is now more than $16.4 trillion dollars - a number so large it is difficult to even relate to.",
"\nRONLIEPERT: Here in Canada, the economic recovery is underway, but it\'s taking longer than the federal government had anticipated.",
"\nRONLIEPERT: My federal counterpart is now projecting a balanced budget in 2015-16.",
"\nRONLIEPERT: While the federal government\'s balancing act of fiscal prudence should be applauded, the fact of the matter is that under this timetable, more than another $100 billion will be added to the federal debt before the books are balanced.",
"\nRONLIEPERT: Ontario, Canada\'s most populous province, is now projecting a balanced budget in 2017-18. Between now and then, another $51 billion will be added to its debt burden.",
"\nRONLIEPERT: By comparison, Albertans can take great pride and comfort in our fiscal situation.",
"\nRONLIEPERT: We, of course, have no debt that is not covered off by cash reserves. And the losses our province suffered during the recession have all been regained.",
"\nRONLIEPERT: Between 2008 and 2009, for example, Alberta lost 28,000 jobs. But by June 2011, all of those jobs had been recovered, plus additional new ones were created.",
"\nRONLIEPERT: In fact, in that month, June of last year, the Alberta economy created more jobs than were created in the entire United States!",
"\nRONLIEPERT: While unemployment is a major concern in other parts of the world, Alberta leads the nation in the creation of new jobs. Employment growth in Alberta was 3.8 percent last year, by far the highest rate in the country. In fact, Alberta accounted for about half of all new jobs created in Canada in 2011.",
"\nRONLIEPERT: And while employers in other jurisdictions are contemplating layoffs and downsizing, businesses in Alberta are beginning to worry about the availability of skilled workers and potential labour shortages.",
"\nRONLIEPERT: Another area where we have seen a positive turnaround is the energy sector. Land lease sales grew from $1.2 billion in 2009-10 to a forecasted record level of $3.3 billion this year. This budget projects more than $2 billion in land sales in 2012-13. This points to the tremendous confidence that exists in Alberta.",
"\nRONLIEPERT: But our provincial budgeting is not without its challenges.",
"\nRONLIEPERT: n 2008-09, natural gas revenues were $5.8 billion. In the upcoming fiscal year, it is estimated that natural gas revenues will be $1.2 billion, or about one-fifth of what they were just four years ago.",
"\nRONLIEPERT: The strong value of the Canadian dollar also impacts our bottom line. In 2012-13, for every one cent increase in the exchange rate over the course of twelve months, the province will receive $247 million less in revenue. And our forecast for the upcoming fiscal year is for the dollar to remain almost at par.",
"\nRONLIEPERT: For us as Albertans, the lesson is clear but so is the opportunity.",
"\nRONLIEPERT: We must put aside the old ways, and equip our province to reach its full potential so we can succeed in the new global economy.",
"\nRONLIEPERT: We must protect the advantages Albertans have worked so hard to achieve, such as strong public services, low taxes and no operating debt.",
"\nRONLIEPERT: We must identify what our priorities are, and act boldly and decisively to make the most of our opportunities.",
"\nRONLIEPERT: We must invest in our greatest resource: our people.",
"\nRONLIEPERT: And so it was to Albertans themselves that we turned when we began crafting this budget. Last November, the President of the Treasury Board and I travelled across the province, meeting with a broad cross-section of Albertans, to get their input as to what was most important to them.",
"\nRONLIEPERT: Albertans also participated in the consultation process through an on-line survey, polling, written submissions and town hall meetings.",
"\nRONLIEPERT: What we heard from Albertans across the province was remarkably consistent and could be categorized into three priority areas: investing in families and communities; securing Alberta\'s economic future and advancing world-leading resource stewardship.",
"\nRONLIEPERT: Members of the Assembly will notice that instead of being organized by department,",
"\nRONLIEPERT: Budget 2012 is organized along these three priorities. We are focused on the things we need to do, not which department is doing them.",
"\nRONLIEPERT: Presenting our budget this way is sharing openly with Albertans what we propose to do, and standing accountable for the outcomes we achieve.",
"\nRONLIEPERT: Mr. Speaker, Alberta\'s economy is forecast to grow by a healthy 3.8 percent this year, up from 3.5 percent in 2011.",
"\nRONLIEPERT: Considering the impact the global economic slowdown is having in other jurisdictions, Albertans are very fortunate to be experiencing such growth.",
"\nRONLIEPERT: Revenues for the upcoming budget year are forecast at $40.3 billion, an increase of $1.8 billion or about 4.6 percent from 2011-12. This is the first time ever, in the history of our province, that projected revenues have exceeded $40 billion.",
"\nRONLIEPERT: Revenues are forecast to keep growing by an average of 10.4 percent over the following two years, reaching $49 billion in 2014-15.",
"\nRONLIEPERT: Increasing revenues are mainly due to higher income tax revenue because of the strength of our economy and higher resource revenues. I will point out, Mr. Speaker, that these higher tax revenues are a result of Albertans and Alberta corporations doing better and thus having higher taxable incomes, and not because of any tax rate increases by the province.",
"\nRONLIEPERT: Budget 2012 introduces no new taxes, or tax rate increases.",
"\nRONLIEPERT: I will also note that in 2014-15, Alberta will receive an additional billion dollars as a result of equitable health transfers from the federal government. This is an inequity that our province has been attempting to resolve for some time, and we are pleased the federal government has moved to a health transfer model that is fair to all provinces.",
"\nRONLIEPERT: Our government will impose strict fiscal discipline to ensure that its revenues and expenditures are managed responsibly, beginning with Bill 1, introduced on Tuesday by the Premier, to mandate results-based budgeting and reviews of all government programs and services.",
"\nRONLIEPERT: This budget also lays the groundwork for three-year funding cycles for municipalities, school boards and post-secondary institutions.",
"\nRONLIEPERT: Stable and predictable funding for these priority areas will allow our partners to plan better for the future, provide better service to Albertans, and offer greater accountability to taxpayers.",
"\nRONLIEPERT: We will challenge government to find ways to achieve the outcomes Albertans want within existing budgets. We will scrutinize all costs and challenge automatic growth of spending, assigning funds only where they are needed.",
"\nRONLIEPERT: We are forecasting a return to a balanced budget in the 2013-14 fiscal year, as our Premier committed, with a projected surplus of nearly one billion dollars. By 2014-15, we are forecasting a surplus of $5.2 billion.",
"\nRONLIEPERT: The return of surplus budgets will bring with it the opportunity to replenish our savings account, the Sustainability Fund. If we meet our projected surplus in 2014-15, the fund will increase to $4.8 billion by the end of that fiscal year.",
"\nRONLIEPERT: Budget 2012 will see total government spending rise by 3.3 percent over last year.",
"\nRONLIEPERT: The increase in expenses is due almost entirely to increased spending in Albertans\' priority",
"\nRONLIEPERT: areas of health, education and social supports for those who need them.",
"\nRONLIEPERT: Mr. Speaker, this increase is less than population growth plus inflation.",
"\nRONLIEPERT: We can afford to spend this much, and we will be disciplined enough to spend no more.",
"\nRONLIEPERT: More than 60 percent of the operating budget has been allocated to families and communities. This is an increase of approximately five percent from last year\'s budget.",
"\nRONLIEPERT: Specifically, base funding to Alberta Health Services will increase by six percent as part of our five-year funding commitment to deliver equitable health services across the province.",
"\nRONLIEPERT: Human Services will receive $2.5 billion.",
"\nRONLIEPERT: When you dig into these numbers, you see some very real and positive outcomes for Albertans.",
"\nRONLIEPERT: One is a 400-dollar-increase in maximum monthly benefits for AISH clients. Our Premier made a promise to increase the income provided to severely handicapped Albertans, and",
"\nRONLIEPERT: Budget 2012 honours that commitment.",
"\nRONLIEPERT: The budget also doubles the employment income exemptions for AISH clients, allowing them to keep more of their benefits while earning income.",
"\nRONLIEPERT: Budget 2012 also increases income support benefits by an average of five percent. This will help about 34,000 households in which Albertans are either training or looking for work, or are unable to work.",
"\nRONLIEPERT: At the end of the day, these funding increases will make a real difference in the lives of some of our most vulnerable citizens.",
"\nRONLIEPERT: Government is also investing in health care, to provide better access to the health system for all Albertans, no matter where they live.",
"\nRONLIEPERT: Budget 2012 allocates $100 million in each of the next three years to help open a new front door to the health system, in the form of Family Care Clinics, and other measures that support primary care and addictions and mental health programs.",
"\nRONLIEPERT: This is another promise made and promise kept by our Premier.",
"\nRONLIEPERT: Construction will continue this year on the Central Alberta Cancer Centre in Red Deer, with completion expected in spring 2013. It will mean that people who used to have to travel to Calgary or Edmonton for radiation treatment will soon be able to get the care they need closer to home, and without added inconvenience and expense at a time when they are already dealing with tremendous challenges.",
"\nRONLIEPERT: Likewise, the opening of the new South Calgary Health Campus this year will make an incredible difference in the lives of Albertans living in our largest city. This will impact not only those people living in the fast-growing south part of Calgary, but everyone in the region, as the facility brings new capacity to the health system and takes some of the pressure off existing hospitals.",
"\nRONLIEPERT: We call this facility a campus, because it will integrate clinical care with education and research. It will also promote wellness and good health, and help patients get well in their homes by connecting them with other community services.",
"\nRONLIEPERT: While building new and expanded infrastructure is key to enhancing our health care system, so too is operating it. All together, Alberta Health Services will receive $267 million to support new staff and other costs related to running new facilities, mainly at the South Calgary Health Campus and Edmonton Clinic South.",
"\nRONLIEPERT: This year, we will continue to support programs to help the homeless, and this is an area where we have seen tremendous progress, Mr. Speaker.",
"\nRONLIEPERT: In the first two years of the Housing First program, more than 4,800 homeless Albertans have been placed in safe and permanent homes.",
"\nRONLIEPERT: We expect another 1,800 Albertans to reclaim lives of dignity and independence during the upcoming year.",
"\nRONLIEPERT: Budget 2012 continues to support municipalities through the flagship Municipal Sustainability Initiative, more commonly known as MSI, with $2.8 billion allocated to this program over the next three years. Since the program began in 2007, more than 6,000 capital and operating projects have benefited communities all across Alberta.",
"\nRONLIEPERT: Mr. Speaker, for our province to continue investing in people, we must diversify our economy and grow our economic pie. This vital work begins in the education system.",
"\nRONLIEPERT: Budget 2012 increases operating funding for education by 3.4 percent to $6.2 billion. Fourteen new schools will be completed in 2012, and just think of the impact this will have on",
"\nRONLIEPERT: children and families in some of our fastest growing communities.",
"\nRONLIEPERT: For some, this will be the first time that children have the opportunity to attend a neighbourhood school that is actually in their neighbourhood.",
"\nRONLIEPERT: School boards in rapidly growing communities can be assured that their growth is recognized, and boards in remote areas will see that their higher transportation costs are acknowledged.",
"\nRONLIEPERT: ...And increases in supports for inclusive education mean that children with extra educational needs will be better supported.",
"\nRONLIEPERT: Budget 2012 continues last fall\'s $107 million funding addition to the education system. The budget also provides an additional 5.1 percent for student transportation services, as the fuel price contingency program is funded for the full year.",
"\nRONLIEPERT: Budget 2012 also invests in post-secondary education. This is an area where government has made significant investments in the past several years.",
"\nRONLIEPERT: Three major projects are expected to be completed in 2012-13: the University of Alberta\'s agricultural facilities in Kinsella and St. Albert, SAIT\'s Trades and Technology Complex, and the phase two expansion of Bow Valley College. These facilities will train thousands of students and provide space for state-of-the-art research to happen.",
"\nRONLIEPERT: We are also seeing the benefits from previous investments in post-secondary institutions. In the five years between 2005 and 2010, total registered apprentices in Alberta grew by",
"\nRONLIEPERT: 36 percent to more than 63,000.",
"\nRONLIEPERT: In fact, even though Alberta has about 11 percent of the country\'s workforce, our province hires and trains more than 20 percent of the country\'s apprentices.",
"\nRONLIEPERT: Our province is a leader, both in creating jobs, and in training skilled workers to fill them.",
"\nRONLIEPERT: Budget 2012 will increase operating funding to Alberta\'s post-secondary institutions by two percent.",
"\nRONLIEPERT: It will also increase support for scientific research through an expanded tax credit, and boost funding for prion and water research by $9 million to help find answers to some of the world\'s most pressing problems.",
"\nRONLIEPERT: Securing Alberta\'s economic future also means investing in the infrastructure that enables growth and enhances our quality of life.",
"\nRONLIEPERT: Over the next three years, government will invest $16.5 billion in capital projects.",
"\nRONLIEPERT: This is a modest decrease of around seven percent from the last fiscal year, but Alberta will still spend 38 percent more per capita than any other province on crucial infrastructure, except for Newfoundland.",
"\nRONLIEPERT: The next three years will see the start of construction on the new Royal Alberta Museum, continued progress on the Edmonton and Calgary ring roads, and work on a number of hospitals, regional health centers and health facilities from Grande Prairie to High Prairie, from Sherwood Park to Medicine Hat, from Bow Island to Edson and points in-between.",
"\nRONLIEPERT: These are things we are doing within our own province. But in the new global economy, Alberta must look far beyond its borders. We must increase our presence and our access to markets in some of the world\'s fastest growing economies, particularly in Asia.",
"\nRONLIEPERT: The urgency of this work and the risk involved when relying on a single market was underscored last month when the Keystone XL pipeline project was delayed yet again.",
"\nRONLIEPERT: Budget 2012 provides support to make Alberta a preferred global supplier of not only energy, but also agriculture, forest products and services.",
"\nRONLIEPERT: This budget invests about $1 billion in Agriculture and Rural Development, reflecting our government\'s continued commitment to building and maintaining our largest renewable industry. These dollars will also ensure we remain competitive both domestically and globally. This investment includes $133 million for industry development, food safety and research.",
"\nRONLIEPERT: Budget 2012 also supports initiatives to make Alberta a global supplier of forest products and promotes projects that turn forest waste into renewable energy.",
"\nRONLIEPERT: Mr. Speaker, Alberta is becoming an increasingly visible player on the world stage. We will take on an even greater role as we gain better market access for our products, and build our nation\'s role as a global energy leader through the development of a Canadian Energy Strategy.",
"\nRONLIEPERT: We do this knowing that taking these steps will put our energy production practices and environmental stewardship under even greater scrutiny. We are not afraid of such scrutiny. We welcome it, along with the opportunity to advance the world-leading resource stewardship that was developed and is practiced right here in Alberta.",
"\nRONLIEPERT: But we also recognize that we must continually improve our environmental performance and monitoring in a way that is credible, comprehensive and transparent.",
"\nRONLIEPERT: Budget 2012 will increase funding for environmental monitoring related to oil sands development in the oil sands region.",
"\nRONLIEPERT: It also allocates $540 million in GreenTRIP funding to advance Alberta\'s leadership in reducing greenhouse gas emissions associated with transportation. This funding also helps make public transit more accessible and better connects Albertans.",
"\nRONLIEPERT: Mr. Speaker, our government is able to make these investments because of the actions we took to put Alberta on sound financial footing.",
"\nRONLIEPERT: Our province worked hard to pay off its accumulated debt and build up the Sustainability Fund to use in difficult times. When the recession struck, and other jurisdictions were borrowing money to finance economic stimulus programs, Alberta was able to maintain its programs without cutbacks, without raising taxes, and without piling on new debt for operations.",
"\nRONLIEPERT: While other provinces were going deeper and deeper into the red, Alberta was embarking on one of the largest infrastructure programs in our province\'s history.",
"\nRONLIEPERT: Not only did this initiative ensure that 160,000 Albertans were able to keep working and supporting their families, but we also now have among the most efficient systems of roads and highways, the most modern schools for our children, the most advanced health facilities and the best libraries and cultural facilities for our citizens. This is a lasting legacy for future generations of Albertans.",
"\nRONLIEPERT: When it comes to modern infrastructure, Albertans can thank our former premier, the Member for Fort Saskatchewan - Vegreville, for his leadership. I know all Albertans recognize and appreciate what has taken place in this province over the past half decade.",
"\nRONLIEPERT: Mr. Speaker, the approach our province took was the right one for the times, but the times have changed. Now we need to consider whether our approach needs to change too, and whether the fiscal framework we have now is the right one for the future.",
"\nRONLIEPERT: During her leadership campaign, our Premier raised some important questions - questions we also heard from Albertans in our budget consultations and during the recent Cabinet tour. Are we using the best revenue mix to fund the programs we need? Are we making the wisest spending decisions? Should we be saving more, or saving differently?",
"\nRONLIEPERT: These are questions we need to consider as a province, recognizing that Alberta has unique challenges when it comes to budgeting. Our province is blessed with abundant natural resources, and in good times, those resources translate into abundant revenues. There have been years when Alberta\'s budget surpluses have been greater than the entire operating budget of some Canadian provinces.",
"\nRONLIEPERT: But other years, resource revenues are lower, and we have difficult decisions to make.",
"\nRONLIEPERT: Albertans tell us that some things - like health and education - are too important to ride the roller coaster of volatile resource revenues. They are asking if we can do better...I say we can.",
"\nRONLIEPERT: We need to look at our fiscal framework: at where and how we collect revenues, where and how we spend, and where and how we save.",
"\nRONLIEPERT: These are the foundations of our fiscal framework. And as His Honour said when he delivered the Speech from the Throne two days ago, we need to change this foundation to put our province on a solid footing for the future.",
"\nRONLIEPERT: Over the next year, our government will open a discussion with Albertans on how best to do this. And over the coming years, we will lead a shift toward a new fiscal framework that will serve Albertans better.",
"\nRONLIEPERT: The first challenge will be building a more predictable, sustainable revenue base to support ongoing programs.",
"\nRONLIEPERT: For too long, we have used all our resource revenues to pay our day-to-day expenses. These revenues rise and fall with global economic fluctuations that we cannot predict and we sure can\'t control.",
"\nRONLIEPERT: It\'s not wise to rely on such a volatile revenue base to pay for essential services that we need all the time. Nor is it fair to our children and grandchildren to spend our whole inheritance of natural resource revenues, because it also belongs to them.",
"\nRONLIEPERT: I believe Albertans understand that we can\'t continue to rely on energy revenues in the same way in the future that we have in the past. They know that we must progressively become less reliant on these revenues to fund ongoing programs.",
"\nRONLIEPERT: They also know that as Albertans, we enjoy the lowest overall tax regime among all the provinces, with a personal tax rate of 10 percent and the highest personal exemptions in Canada. This keeps more money in Albertans\' pockets.",
"\nRONLIEPERT: When compared to other provinces, Albertans pay at least $11 billion less annually in personal and corporate tax, and that will continue to be the case.",
"\nRONLIEPERT: Alberta will maintain the lowest overall corporate and small business tax burden in Canada. We will continue to have the lowest fuel tax, no payroll tax, no capital tax and no sales tax.",
"\nRONLIEPERT: Budget 2012 makes no changes to Alberta\'s tax structure or rates. But as we move away from volatile resource revenues to fund ongoing programs, and move toward a more sustainable revenue base, we know that a discussion on taxes must lie in Alberta\'s future.",
"\nRONLIEPERT: This discussion will involve all Albertans and all sectors of the Alberta economy. And it will be based on the premise that while the tax system may change, one thing that must not change is Alberta\'s tax advantage.",
"\nRONLIEPERT: Alberta\'s low tax regime is one of the things that sets our province apart, and gives us a competitive edge that must be preserved.",
"\nRONLIEPERT: Mr. Speaker, putting a budget together is about more than dollars and cents.",
"\nRONLIEPERT: It\'s about ensuring that government is supporting the outcomes Albertans want to achieve for themselves and their families.",
"\nRONLIEPERT: It\'s about investing in people, and in the things that are important to Albertans, such as health, education, jobs, services for seniors and the vulnerable, infrastructure and our children\'s future.",
"\nRONLIEPERT: It\'s about protecting the advantages Albertans have worked so hard to build - not only first-rate services and modern infrastructure, but also a clean balance sheet and low taxes.",
"\nRONLIEPERT: And it\'s about keeping the commitments our Premier and our government have made. Budget 2012 does all these things.",
"\nRONLIEPERT: It invests in Albertans\' priorities - our people - while returning to a balanced budget next year without raising taxes.",
"\nRONLIEPERT: This budget also signals important work we must do to move Alberta toward a new fiscal framework - one that will increase stability and predictability in government revenues and bring spending under more scrutiny and greater discipline than ever before.",
"\nRONLIEPERT: With Alberta\'s economy heating up and the province poised to return to surpluses, this is the time to ensure that government is providing the right services in the most efficient way possible, while putting our long-term revenue and savings strategies on sounder footing.",
"\nRONLIEPERT: This budget is the start of what we want to accomplish in the coming three years, and what we will strive to achieve over the next 10 years. The steps we take today will bring us closer to our goals.",
"\nRONLIEPERT: Mr. Speaker, I said at the outset of my remarks that presenting this budget was a milestone for me, and indeed it is.",
"\nRONLIEPERT: I believe it\'s also a milestone for our province, as we take the first steps to building a new fiscal foundation - one that protects our hard-won advantages, while arming Alberta for success in the new global economy, and helping us reach our full potential.",
"\nRONLIEPERT: Our government worked very hard to build this budget, based on what we\'ve heard from Albertans, and I believe it\'s the right budget for Alberta today. It\'s a responsible budget.",
"\nRONLIEPERT: Presenting it to the Assembly has been both an honour and a privilege, and I look forward to debating it in this Legislature over the coming weeks.",
"\nRONLIEPERT: Thank you, Mr. Speaker."
]
});

data.speakers = {
"RONLIEPERT": {name: "Ron Liepert", title:"Minister of Finance"}
};

data.topics = [
"budget",
"albertans",
"alberta",
"province",
"billion",
"revenues",
"health",
"new",
"percent",
"government",
"tax",
"year",
"mr",
"speaker",
"years",
"fiscal",
"increase",
"must",
"services",
"over",
"alberta",
"funding",
"one",
"need",
"programs",
"economy",
"future",
"education",
"resource",
"last",
"support",
"global",
"premier",
"better",
"next",
"make",
"three",
"first",
"million",
"energy",
"system",
"revenue",
"things",
"debt",
"infrastructure",
"without",
"economic",
"operating",
"jobs",
"care",
"people",
"facilities",
"federal",
"fund",
"time",
"work",
"continue",
"taxes",
"growth",
"because",
"dollars",
"increases",
"communities",
"rate",
"income",
"balanced",
"spend",
"past",
"calgary",
"projects",
"take",
"families",
"greater",
"research",
"provinces",
"see",
"important",
"framework",
"opportunity",
"children",
"assembly",
"achieve",
"spending",
"higher",
"two",
"right",
"investing",
"help"
  ].map(topic);

data.topic = function(name) {
  //var t = topic({name: name, re: new RegExp("\\b(" + d3.requote(name) + ")\\b", "gi")});
  var t = topic({name: name, re: new RegExp("\\b(" + d3.requote(name) + ")\\b", "gi")});
  data.topics.push(t);
  return t;
};

function budgetspeech(budgetspeech) {
  budgetspeech.speeches = budgetspeech.speeches.map(speech);
  budgetspeech.sections = sections(budgetspeech.speeches);
  return budgetspeech;
}

function speech(text, i) {
  return {text: text, id: i};
}

function sections(speeches) {
  var speakerRe = /(?:\n|^)([A-Z\.()\- ]+): /g,
      sections = [];
/*
  speeches.forEach(function(speech) {
    var speakerName = "RONLIEPERT",
        match,
        i = speakerRe.lastIndex = 0;
    while (match = speakerRe.exec(speech.text)) {
      if (match.index > i) sections.push({speaker: speakerName, speech: speech, i: i, j: match.index});
      speakerName = match[1];
      i = speakerRe.lastIndex;
    }
    sections.push({speaker: speakerName, speech: speech, i: i, j: speech.text.length});
  });

*/

  speeches.forEach(function(speech) {
    var speakerName = "RONLIEPERT",
        match,
        i = speakerRe.lastIndex = 0;
    while (match = speakerRe.exec(speech.text)) {
      if (match.index > i) sections.push({speaker: speakerName, speech: speech, i: i, j: match.index});
      speakerName = match[1];
      i = speakerRe.lastIndex;
    }
    sections.push({speaker: speakerName, speech: speech, i: i, j: speech.text.length});
  });



  return sections.filter(function(d) { return !/^RONLIEPERT\b/.test(d.speaker); });
}

function topic(topic) {
  if (!topic.re) topic = {name: topic, re: new RegExp("\\b(" + d3.requote(topic) + ")\\b", "gi")};

  topic.count = 0;
  topic.mentions = [];

  data.sections.forEach(function(section) {
    var text = section.speech.text.substring(section.i, section.j), match;
    topic.re.lastIndex = 0;
    while (match = topic.re.exec(text)) {
      ++topic.count;
      topic.mentions.push({
        topic: topic,
        section: section,
        i: section.i + match.index,
        j: section.i + topic.re.lastIndex
      });
    }
  });

  return topic;
}

})();

(function() {

var width = 970,
    height = 500;

var padding = 4, // collision padding
    maxRadius = 75, // collision search radius
    maxMentions = 25, // limit displayed mentions
    activeTopic; // currently-displayed topic

var r = d3.scale.sqrt()
    .domain([0, d3.max(data.topics, function(d) { return d.count; })])
    .range([0, maxRadius]);

var force = d3.layout.force()
    .gravity(0)
    .charge(0)
    .size([width, height])
    .on("tick", tick);


var node = d3.select(".g-nodes").selectAll(".g-node"),
    label = d3.select(".g-labels").selectAll(".g-label");

d3.select(".g-nodes").append("rect")
    .attr("class", "g-overlay")
    .attr("width", width)
    .attr("height", height)
    .on("click", clear);

d3.select(window)
    .on("hashchange", hashchange);

d3.select("#g-form")
    .on("submit", submit);

updateTopics(data.topics);
hashchange();

// Update the known topics.
function updateTopics(topics) {
  topics.forEach(function(d, i) { d.r = Math.max(12, r(d.count)); }); // min. collision
  force.nodes(data.topics = topics).start();
  updateNodes();
  updateLabels();
}

// Update the displayed nodes.
function updateNodes() {
  node = node.data(data.topics, function(d) { return d.name; });

  node.exit().remove();

  node.enter().append("a")
      .attr("class", "g-node")
      .attr("xlink:href", function(d) { return "#" + encodeURIComponent(d.name); })
      .call(force.drag)
      .call(linkTopic)
    .append("circle");

  node.select("circle")
      .attr("r", function(d) { return r(d.count); });
}

// Update the displayed node labels.
function updateLabels() {
  label = label.data(data.topics, function(d) { return d.name; });

  label.exit().remove();

  var labelEnter = label.enter().append("a")
      .attr("class", "g-label")
      .attr("href", function(d) { return "#" + encodeURIComponent(d.name); })
      .call(force.drag)
      .call(linkTopic);

  labelEnter.append("div")
      .attr("class", "g-name")
      .text(function(d) { return d.name; });

  labelEnter.append("div")
      .attr("class", "g-value");

  label
      .style("font-size", function(d) { return Math.max(8, r(d.count) / 2) + "px"; })
      .style("width", function(d) { return r(d.count) * 2.5 + "px"; });

  // Create a temporary span to compute the true text width.
  label.append("span")
      .text(function(d) { return d.name; })
      .each(function(d) { d.dx = Math.max(2.5 * r(d.count), this.getBoundingClientRect().width); })
      .remove();

  label
      .style("width", function(d) { return d.dx + "px"; })
    .select(".g-value")
      .text(function(d) { return d.count + (d.r > 60 ? " mentions" : ""); });

  // Compute the height of labels when wrapped.
  label.each(function(d) { d.dy = this.getBoundingClientRect().height; });
}

// Update the active topic.
function updateActiveTopic(topic) {
  if (activeTopic = topic) {
    node.classed("g-selected", function(d) { return d === topic; });
    updateMentions(findMentions(topic));
    d3.select("#g-topic").text((topic.count > maxMentions ? "A sampling of " : topic.count || "No") + " mentions of " + topic.name + ".");
  } else {
    node.classed("g-selected", false);
    updateMentions(sampleMentions());
    d3.select("#g-topic").text("Lucastimmons tweets");
  }
}

// Update displayed excerpts.
function updateMentions(mentions) {

  // Rather than compute a data-join, just blow away the entire layout.
  // With wider support for multi-column layout, a data-join would work.
  var column = d3.selectAll(".g-mentions")
      .datum(0)
      .html(null);

  var heights = column.data(),
      indexes = d3.range(heights.length),
      speakers = groupMentionsBySpeaker(mentions);

  speakers.sort(function(a, b) { return b.values.length - a.values.length; });

  // Incrementally add each new speaker to the shortest column.
  speakers.forEach(function(d) {
    var index = d3.first(indexes, function(a, b) { return heights[a] - heights[b]; }),
        speakerName = d.values[0].section.speaker,
        speaker = data.speakers[speakerName];

    var div = d3.select(column[0][index]).append("div")
        .attr("class", "g-mention");

    div.append("div")
        .attr("class", "g-speaker")
        .text(speaker ? speaker.name : speakerName);

    div.append("div")
        .attr("class", "g-speaker-title")
        .text(speaker ? speaker.title : "");

    var p = div.selectAll("p")
        .data(d.values)
      .enter().append("p")
        .html(function(d) { return d.section.speech.text.substring(d.start, d.end).replace(d.topic.re, "<a>$1</a>"); });

    if (activeTopic) {
      p.attr("class", "g-hover");
    } else {
      p.each(function(d) {
        d3.select(this).selectAll("a")
            .datum(d.topic)
            .attr("href", "#" + encodeURIComponent(d.topic.name))
            .call(linkTopic);
      });
    }

    heights[index] += div.node().getBoundingClientRect().height;
  });
}

// Return a random sample of mentions, one per topic.
// Mentions are returned in chronological order.
function sampleMentions() {
  return data.topics
      .filter(function(d) { return d.mentions.length; })
      .map(function(d) { return d.mentions[Math.floor(Math.random() * d.mentions.length)]; })
      .sort(orderMentions);
}

// Return displayable mentions for the specified topic.
// If too many, a random sample of matching mentions is returned.
// Mentions are returned in chronological order.
function findMentions(topic) {
  var mentions = topic.mentions;
  if (mentions.length > maxMentions) {
    shuffle(mentions).length = maxMentions;
    mentions.sort(orderMentions);
  }
  return mentions;
}

// Group mentions by speaker, collapse overlapping excerpts.
function groupMentionsBySpeaker(mentions) {
  return d3.nest()
      .key(function(d) { return d.section.speaker; })
      .rollup(collapseMentions)
      .entries(mentions);
}

// Given an array of mentions, computes the start and end point of the context
// excerpt, and then collapses any overlapping excerpts.
function collapseMentions(mentions) {
  var sentenceRe = /([!?.)]+)\s+/g, // sentence splitting requires NLP
      i,
      n = mentions.length,
      d0,
      d1;

  // First compute the excerpt contexts.
  for (i = 0; i < n; ++i) {
    d0 = mentions[i];
    d0.start = excerptStart(d0);
    d0.end = excerptEnd(d0);
  }

  // Then collapse any overlapping excerpts (from the same speech).
  for (i = 1, d1 = mentions[0]; i < n; ++i) {
    d0 = d1;
    d1 = mentions[i];
    if (d1.section.speech.id === d0.section.speech.id
        && d1.start >= d0.start
        && d1.start < d0.end) {
      d1.start = -1;
      d0.end = d1.end;
      d1 = d0;
    }
  }

  // Returns the start index of the excerpt for the specified mention.
  function excerptStart(mention) {
    var i = sentenceRe.lastIndex = Math.max(mention.section.i, mention.i - 80), match;
    while (match = sentenceRe.exec(mention.section.speech.text)) {
      if (match.index < mention.i - 20) return match.index + match[0].length;
      if (i <= mention.section.i) break;
      sentenceRe.lastIndex = i = Math.max(mention.section.i, i - 20);
    }
    return mention.section.i;
  }

  // Returns the end index of the excerpt for the specified mention.
  function excerptEnd(mention) {
    var i = mention.section.j, match;
    sentenceRe.lastIndex = mention.j + 40;
    match = sentenceRe.exec(mention.section.speech.text);
    return match ? Math.min(match.index + match[1].length, i) : i;
  }

  return mentions.filter(function(d) { return d.start >= 0; });
}

// Orders mentions chronologically: by speech and position within speech.
function orderMentions(a, b) {
  return a.section.speech.id - b.section.speech.id || a.i - b.i;
}

// Assign event handlers to topic links.
function linkTopic(a) {
  a   .on("click", click);
      //.on("mouseover", mouseover)
      //.on("mouseout", mouseout);
}

// Returns the topic matching the specified name, approximately.
// If no matching topic is found, returns undefined.
function findTopic(name) {
  for (var i = 0, n = data.topics.length, t; i < n; ++i) {
    if ((t = data.topics[i]).name === name || new RegExp("^" + (t = data.topics[i]).re.source + "$", "i").test(name)) {
      return t;
    }
  }
}

// Returns the topic matching the specified name, approximately.
// If no matching topic is found, a new one is created.
function findOrAddTopic(name) {
  var topic = findTopic(name);
  return topic;
}

// Simulate forces and update node and label positions on tick.
function tick(e) {
  node
      .each(gravity(e.alpha * .1))
      .each(collide(.5))
      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

  label
      .style("left", function(d) { return (d.x - d.dx / 2) + "px"; })
      .style("top", function(d) { return (d.y - d.dy / 2) + "px"; });
}

// Custom gravity to favor a non-square aspect ratio.
function gravity(alpha) {
  var cx = width / 2,
      cy = height / 2,
      ax = alpha / 4,
      ay = alpha;
  return function(d) {
    d.x += (cx - d.x) * ax;
    d.y += (cy - d.y) * ay;
  };
}

// Resolve collisions between nodes.
function collide(alpha) {
  var q = d3.geom.quadtree(data.topics);
  return function(d) {
    var r = d.r + maxRadius + padding,
        nx1 = d.x - r,
        nx2 = d.x + r,
        ny1 = d.y - r,
        ny2 = d.y + r;
    q.visit(function(quad, x1, y1, x2, y2) {
      if (quad.point && (quad.point !== d) && d.other !== quad.point && d !== quad.point.other) {
        var x = d.x - quad.point.x,
            y = d.y - quad.point.y,
            l = Math.sqrt(x * x + y * y),
            r = d.r + quad.point.r + padding;
        if (l < r) {
          l = (l - r) / l * alpha;
          d.x -= x *= l;
          d.y -= y *= l;
          quad.point.x += x;
          quad.point.y += y;
        }
      }
      return x1 > nx2 || x2 < nx1 || y1 > ny2 || y2 < ny1;
    });
  };
}

// Fisherâ€“Yates shuffle.
function shuffle(array) {
  var m = array.length, t, i;
  while (m) {
    i = Math.floor(Math.random() * m--);
    t = array[m];
    array[m] = array[i];
    array[i] = t;
  }
  return array;
}

// Update the active topic on hashchange, perhaps creating a new topic.
function hashchange() {
  var name = decodeURIComponent(location.hash.substring(1)).trim();
  updateActiveTopic(findTopic(name));
}

// Trigger a hashchange on submit.
function submit() {
  var name = this.search.value.trim();
  location.hash = name ? encodeURIComponent(name) : "!";
  this.search.value = "";
  d3.event.preventDefault();
}

// Clear the active topic when clicking on the chart background.
function clear() {
  location.replace("#!");
}

// Rather than flood the browser history, use location.replace.
function click(d) {
  location.replace("#" + encodeURIComponent(d === activeTopic ? "!" : d.name));
  d3.event.preventDefault();
}


})();